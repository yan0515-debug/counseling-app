import streamlit as st
import pandas as pd
import altair as alt
import numpy as np # æ–°å¢ numpy é€²è¡Œçµ±è¨ˆè¨ˆç®—

# --- ç³»çµ±è¨­å®š ---
st.set_page_config(page_title="è«®å•†å°ˆæ¥­å–å‘æ·±åº¦æ¢ç´¢ç³»çµ± (CTOS-Pro)", page_icon="ğŸ§­", layout="wide")

# --- Session State åˆå§‹åŒ– ---
if 'axis_obj_sub' not in st.session_state:
    st.session_state.axis_obj_sub = 0.0 
if 'axis_ana_exp' not in st.session_state:
    st.session_state.axis_ana_exp = 0.0
if 'history' not in st.session_state:
    st.session_state.history = [] 
# æ–°å¢ï¼šè¨˜éŒ„åŸå§‹åˆ†æ•¸é™£åˆ—ï¼Œç”¨æ–¼è¨ˆç®—è®Šç•°æ•¸ (Consistency Check)
if 'raw_scores_x' not in st.session_state:
    st.session_state.raw_scores_x = []
if 'raw_scores_y' not in st.session_state:
    st.session_state.raw_scores_y = []

# --- è¼”åŠ©å‡½æ•¸ ---
def update_axes(x_delta, y_delta, phase, choice_text, reasoning):
    st.session_state.axis_obj_sub += x_delta
    st.session_state.axis_ana_exp += y_delta
    
    # è¨˜éŒ„åŸå§‹åˆ†æ•¸è®ŠåŒ–ï¼Œç”¨æ–¼çŸ›ç›¾æª¢æ¸¬
    st.session_state.raw_scores_x.append(x_delta)
    st.session_state.raw_scores_y.append(y_delta)
    
    st.session_state.history.append({
        "phase": phase,
        "choice": choice_text,
        "reasoning": reasoning
    })

# --- CSS æ¨£å¼ ---
st.markdown("""
<style>
    .big-font { font-size:20px !important; font-weight: 600; color: #2c3e50; }
    .tool-card {
        background-color: #ffffff;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        height: 100%;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .tool-icon { font-size: 40px; margin-bottom: 10px; }
    .tool-title { font-size: 22px; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
    .tool-desc { font-size: 16px; color: #555; line-height: 1.5; }
    .scenario-box { 
        background-color: #f8f9fa; 
        padding: 25px; 
        border-radius: 8px; 
        border-left: 6px solid #34495e; 
        margin-bottom: 25px;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        line-height: 1.6;
    }
    .warning-box {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
    }
</style>
""", unsafe_allow_html=True)

# --- å´é‚Šæ¬„ ---
st.sidebar.title("ğŸ§­ ç³»çµ±å°èˆª")
st.sidebar.warning("âš ï¸ é‡è¦æç¤ºï¼š\næ¯ä¸€é¡Œä½œç­”å¾Œï¼Œè«‹å‹™å¿…é»æ“Šä¸‹æ–¹çš„ã€Œç¢ºèªé€å‡ºã€æŒ‰éˆ•ï¼Œç³»çµ±æ‰æœƒè¨˜éŒ„æ‚¨çš„æ•¸æ“šã€‚")

step = st.sidebar.radio(
    "é€²åº¦ï¼š",
    ["å‰è¨€ï¼šæ–¹æ³•è«–èˆ‡æ¶æ§‹", "Phase 1. éš±å–»æŠ•å°„ (è§’è‰²è§€)", "Phase 2. è‡¨åºŠæ±ºç­– (æ”¹è®Šè§€)", "Phase 3. é™°å½±æ¢ç´¢ (åƒ¹å€¼è§€)", "Phase 4. ç©ºé–“é…ç½® (æ¡†æ¶è§€)", "Phase 5. ç¶œåˆåˆ†æå ±å‘Š"]
)

# ==========================================
# å‰è¨€
# ==========================================
if step == "å‰è¨€ï¼šæ–¹æ³•è«–èˆ‡æ¶æ§‹":
    st.title("è«®å•†å°ˆæ¥­å–å‘æ·±åº¦æ¢ç´¢ç³»çµ± (CTOS-Pro)")
    st.markdown("### ç³»çµ±å»ºç½®é‚è¼¯èˆ‡ç†è«–åŸºç¤")
    st.markdown("""
    æœ¬ç³»çµ±å°ˆç‚ºè«®å•†å¿ƒç†å­¸èƒŒæ™¯ä¹‹å°ˆæ¥­äººå“¡è¨­è¨ˆï¼Œæ—¨åœ¨é€éå¤šç¶­åº¦çš„è‡ªæˆ‘è©•ä¼°ï¼Œæ¢ç´¢å€‹äººçš„**è«®å•†ç†è«–å–å‘**ã€‚
    
    #### 1. ç†è«–æ¶æ§‹ (Theoretical Framework)
    æœ¬æ¸¬é©—ä¾æ“š **Poznanski & McLennan (1995) CTPS** èˆ‡ **TOPS-R** é‡è¡¨ï¼Œå°‡å–å‘è§£æ§‹ç‚ºé›™è»¸å‘ï¼š
    * **X è»¸ï¼šçŸ¥è­˜è«–ç«‹å ´** (å®¢è§€å¯¦è­‰ vs. ä¸»è§€å»ºæ§‹)
    * **Y è»¸ï¼šä»‹å…¥ç„¦é»** (ç†æ€§åˆ†æ vs. æƒ…æ„Ÿé«”é©—)

    #### 2. æª¢æ¸¬æ©Ÿåˆ¶ (Quality Control)
    ç‚ºäº†ç¢ºä¿çµæœçš„ä¿¡åº¦ï¼Œæœ¬ç³»çµ±å…§å»º**çŸ›ç›¾æª¢æ¸¬æ¼”ç®—æ³•**ã€‚è‹¥æ‚¨çš„ä½œç­”åœ¨ä¸åŒéšæ®µå‡ºç¾é«˜åº¦ç‰´è§¸ï¼ˆä¾‹å¦‚ï¼šåœ¨éš±å–»é¡Œé¸æ“‡æ¥µåº¦å®¢è§€ï¼Œå»åœ¨æƒ…å¢ƒé¡Œé¸æ“‡æ¥µåº¦ä¸»è§€ï¼‰ï¼Œç³»çµ±å°‡åœ¨æœ€çµ‚å ±å‘Šä¸­æå‡ºè­¦ç¤ºèˆ‡æ•´åˆæ€§å»ºè­°ã€‚

    #### 3. è²æ˜
    * **å‹•æ…‹æ€§**ï¼šçµæœåƒ…ä»£è¡¨ã€Œç•¶ä¸‹ã€çš„å‚¾å‘ã€‚
    * **å»ºè­°æ€§è³ª**ï¼šåˆ†æçµæœåƒ…ä¾›è‡ªæˆ‘è¦ºå¯Ÿåƒè€ƒã€‚
    
    ---
    #### âš ï¸ ä½œç­”èªªæ˜
    **è«‹æ³¨æ„ï¼šæ¯ä¸€é¡Œä½œç­”å®Œç•¢å¾Œï¼Œçš†é ˆé»æ“Šè©²é¡Œä¸‹æ–¹çš„ã€Œç¢ºèªæŒ‰éˆ•ã€ï¼Œç³»çµ±æ‰æœƒé€²è¡Œè¨ˆåˆ†ã€‚**
    """)

# ==========================================
# Phase 1: éš±å–»æŠ•å°„ (åœ–ç‰‡èˆ‡å·¥å…·å„ªåŒ–)
# ==========================================
elif step == "Phase 1. éš±å–»æŠ•å°„ (è§’è‰²è§€)":
    st.header("Phase 1: æ²»ç™‚é—œä¿‚ä¸­çš„è§’è‰²éš±å–»")
    
    # --- Q1: ç™»å±±éš±å–» (æ›´æ›ç‚ºæ›´ç¬¦åˆæè¿°çš„åœ–ç‰‡) ---
    st.markdown("#### Q1. è‹¥å°‡è«®å•†æ­·ç¨‹æ¯”å–»ç‚ºä¸€æ¬¡ç™»å±±ï¼Œè«‹è§€å¯Ÿä¸‹åˆ—åœ–åƒï¼Œæ‚¨èªç‚ºè‡ªå·±çš„åŠŸèƒ½æœ€æ¥è¿‘å“ªä¸€ç¨®è§’è‰²ï¼Ÿ")
    
    c1, c2 = st.columns(2)
    with c1:
        # A. åš®å°ï¼šä¸€äººåœ¨å‰æŒ‡è·¯ï¼Œä¸€äººåœ¨å¾Œ
        st.image("https://images.unsplash.com/photo-1501555088652-021faa106b9b?w=500", caption="A")
    with c2:
        # B. ä¼´ä¾¶ï¼šå…©äººåœ¨é›ªåœ°/å±±å¾‘ä¸¦è‚©è¡Œèµ°
        st.image("https://images.unsplash.com/photo-1605130284535-11dd9eedc58a?w=500", caption="B")
    
    c3, c4 = st.columns(2)
    with c3:
        # C. è§€å¯Ÿè€…ï¼šç«™åœ¨é«˜è™•æˆ–é è™•è§€çœ‹ (ç”¨æœ›é é¡æˆ–èƒŒå½±)
        st.image("https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?w=500", caption="C")
    with c4:
        # D. æ•™ç·´ï¼šæ”€å²©ç¢ºä¿ï¼Œæ˜é¡¯çš„æŒ‡å°èˆ‡ä¿è­·å‹•ä½œ
        st.image("https://images.unsplash.com/photo-1522163182402-834f871fd851?w=500", caption="D")

    choice1 = st.radio("è«‹é¸æ“‡æœ€è²¼è¿‘çš„è§’è‰²åŸå‹ï¼š", [
        "A. åš®å° (Guide)ï¼šç†Ÿæ‚‰åœ°åœ–èˆ‡åœ°å½¢ï¼Œèƒ½é å‘Šæ½›åœ¨å±éšªä¸¦è¦åŠƒå®‰å…¨è·¯å¾‘ã€‚",
        "B. ä¼´ä¾¶ (Partner)ï¼šé…åˆå°æ–¹çš„é€Ÿåº¦ä¸¦è‚©åŒè¡Œï¼Œå…±åŒç¶“æ­·æ—…ç¨‹çš„é¢¨é›¨ã€‚",
        "C. è§€å¯Ÿè€… (Observer)ï¼šä½æ–¼åˆ¶é«˜é»æˆ–å¾Œæ–¹ï¼Œä¿æŒè¦–é‡ï¼Œåˆ†æå…¶æ­¥ä¼èˆ‡æ…£æ€§ã€‚",
        "D. æ•™ç·´ (Coach)ï¼šåœ¨æ—ç¢ºä¿å®‰å…¨ï¼ŒæŒ‡å°æ‰‹è…³çš„æ–½åŠ›é»ï¼Œå”åŠ©ç™¼æ®æ½›èƒ½ã€‚"
    ])
    
    if st.button("ç¢ºèª Q1"):
        if "A" in choice1: update_axes(2.0, 1.0, "P1-Q1", choice1, "åš®å°ï¼šå®¢è§€æŒ‡å°")
        if "B" in choice1: update_axes(-2.0, -2.0, "P1-Q1", choice1, "ä¼´ä¾¶ï¼šä¸»è§€é«”é©—")
        if "C" in choice1: update_axes(-1.0, 3.0, "P1-Q1", choice1, "è§€å¯Ÿè€…ï¼šå‹•åŠ›åˆ†æ")
        if "D" in choice1: update_axes(2.0, 2.0, "P1-Q1", choice1, "æ•™ç·´ï¼šç†æ€§è¡Œå‹•")
        st.success("æ•¸æ“šå·²è¨˜éŒ„ã€‚")

    st.markdown("---")

    # --- Q2: é­”æ³•å·¥å…· (å¡ç‰‡å¼è¨­è¨ˆ + æ”¾å¤§å­—é«”) ---
    st.markdown("#### Q2. æ‰¿ä¸Šé¡Œï¼Œè‹¥æ‚¨èƒ½æ“æœ‰ä¸€é …ã€Œæ ¸å¿ƒå·¥å…·ã€ä¾†å”åŠ©å€‹æ¡ˆï¼Œæ‚¨çš„ç›´è¦ºé¦–é¸ç‚ºä½•ï¼Ÿ")
    st.markdown("è«‹é¸æ“‡æ‚¨åœ¨æ²»ç™‚ä¸­æœ€ç¿’æ…£ä½¿ç”¨çš„ã€Œä»‹å…¥æ–¹å‘ã€ã€‚")

    # ä½¿ç”¨ HTML è£½ä½œæ¼‚äº®çš„å¡ç‰‡
    t1, t2 = st.columns(2)
    with t1:
        st.markdown("""
        <div class="tool-card">
            <div class="tool-icon">ğŸ”¦</div>
            <div class="tool-title">æ‰‹é›»ç­’</div>
            <div class="tool-desc">
                <b>åŠŸèƒ½ï¼š</b>ç…§äº®é»‘æš—è§’è½<br>
                <b>æ–¹å‘ï¼š</b>æ·±å…¥æ½›æ„è­˜èˆ‡æœªçŸ¥<br>
                <b>éš±å–»ï¼š</b>çœ‹è¦‹è¢«å£“æŠ‘çš„çœŸå¯¦
            </div>
        </div>
        """, unsafe_allow_html=True)
        st.write("") # Spacer
        if st.checkbox("é¸æ“‡ã€Œæ‰‹é›»ç­’ã€"):
             update_axes(-1.0, 2.5, "P1-Q2", "æ‰‹é›»ç­’", "å·¥å…·ï¼šæ¢ç´¢æ½›æ„è­˜")
             st.success("å·²é¸æ“‡æ‰‹é›»ç­’")

    with t2:
        st.markdown("""
        <div class="tool-card">
            <div class="tool-icon">ğŸ§£</div>
            <div class="tool-title">æ¯›æ¯¯</div>
            <div class="tool-desc">
                <b>åŠŸèƒ½ï¼š</b>æä¾›æº«æš–èˆ‡åŒ…å®¹<br>
                <b>æ–¹å‘ï¼š</b>å‘å…§çš„æƒ…æ„Ÿæ’«æ…°<br>
                <b>éš±å–»ï¼š</b>å»ºç«‹å®‰å…¨çš„çŸ¯æ­£æ€§ç¶“é©—
            </div>
        </div>
        """, unsafe_allow_html=True)
        st.write("")
        if st.checkbox("é¸æ“‡ã€Œæ¯›æ¯¯ã€"):
            update_axes(-2.0, -1.5, "P1-Q2", "æ¯›æ¯¯", "å·¥å…·ï¼šæä¾›æ¶µå®¹")
            st.success("å·²é¸æ“‡æ¯›æ¯¯")
            
    st.write("") # Spacer
    
    t3, t4 = st.columns(2)
    with t3:
        st.markdown("""
        <div class="tool-card">
            <div class="tool-icon">ğŸª</div>
            <div class="tool-title">é¡å­</div>
            <div class="tool-desc">
                <b>åŠŸèƒ½ï¼š</b>å¦‚å¯¦åæ˜ åŸè²Œ<br>
                <b>æ–¹å‘ï¼š</b>ç•¶ä¸‹çš„ç¾è±¡å­¸åæ˜ <br>
                <b>éš±å–»ï¼š</b>ä¸åŠ æ‰­æ›²çš„çœŸèª ä¸€è‡´
            </div>
        </div>
        """, unsafe_allow_html=True)
        st.write("")
        if st.checkbox("é¸æ“‡ã€Œé¡å­ã€"):
            update_axes(-1.0, -1.0, "P1-Q2", "é¡å­", "å·¥å…·ï¼šç¾è±¡å­¸åæ˜ ")
            st.success("å·²é¸æ“‡é¡å­")

    with t4:
        st.markdown("""
        <div class="tool-card">
            <div class="tool-icon">ğŸ§­</div>
            <div class="tool-title">æŒ‡å—é‡</div>
            <div class="tool-desc">
                <b>åŠŸèƒ½ï¼š</b>æŒ‡å‡ºæ­£ç¢ºæ–¹ä½<br>
                <b>æ–¹å‘ï¼š</b>å‘å¤–çš„ç›®æ¨™å°å‘<br>
                <b>éš±å–»ï¼š</b>å›æ­¸ç†æ€§çš„ç¾å¯¦åˆ¤æ–·
            </div>
        </div>
        """, unsafe_allow_html=True)
        st.write("")
        if st.checkbox("é¸æ“‡ã€ŒæŒ‡å—é‡ã€"):
            update_axes(2.0, 1.5, "P1-Q2", "æŒ‡å—é‡", "å·¥å…·ï¼šç›®æ¨™å°å‘")
            st.success("å·²é¸æ“‡æŒ‡å—é‡")

    st.markdown("---")

    # --- Q3: æ ¡æº–é¡Œ (å›æ­¸) ---
    st.markdown("#### Q3. ç†è«–æ ¡æº– (Calibration)")
    st.markdown("""
    <div style="font-size: 18px; padding: 15px; border: 1px solid #ddd; background-color:#fafafa; border-radius: 5px;">
    <b>é¡Œç›®èªªæ˜ï¼š</b>æ­¤é¡Œç”¨æ–¼æ ¡æº–æ‚¨çš„åŸºæœ¬çŸ¥è­˜è«–ç«‹å ´ã€‚è«‹è©•ä¼°æ‚¨å°ä»¥ä¸‹æ•˜è¿°çš„èªåŒç¨‹åº¦ï¼š<br><br>
    <b>ã€Œæˆ‘èªç‚ºæ²»ç™‚å¸«ä¿æŒå®¢è§€ä¸­ç«‹çš„ã€æŠ€è¡“å°ˆå®¶ã€å½¢è±¡ï¼Œæ¯”å±•ç¾å€‹äººç‰¹è³ªæ›´é‡è¦ã€‚ã€</b>
    </div>
    """, unsafe_allow_html=True)
    
    q3_score = st.slider("1 (éå¸¸ä¸åŒæ„ / é‡è¦–å€‹äººç‰¹è³ª) <---> 5 (éå¸¸åŒæ„ / é‡è¦–å°ˆå®¶å½¢è±¡)", 1, 5, 3)
    
    if st.button("ç¢ºèª Q3 æ ¡æº–"):
        # 1åˆ†=ä¸»è§€(-), 5åˆ†=å®¢è§€(+)
        val = q3_score - 3
        update_axes(val * 1.5, 0, "P1-Q3", f"æ ¡æº–åˆ†æ•¸ {q3_score}", "æ ¡æº–ï¼šå°ˆå®¶å½¢è±¡èªåŒåº¦")
        st.success("æ ¡æº–æ•¸æ“šå·²è¨˜éŒ„ã€‚")

# ==========================================
# Phase 2: è‡¨åºŠæ±ºç­– (ç´”æ·¨ç‰ˆ)
# ==========================================
elif step == "Phase 2. è‡¨åºŠæ±ºç­– (æ”¹è®Šè§€)":
    st.header("Phase 2: æ”¹è®Šæ©Ÿåˆ¶çš„è§€é»")
    
    # --- æƒ…å¢ƒ 1 ---
    st.markdown('<div class="scenario-box"><b>æƒ…å¢ƒ 1ï¼šè‡ªæˆ‘å¦å®š</b><br>å€‹æ¡ˆä½è‘—é ­ï¼Œèªæ°£é¡«æŠ–åœ°èªªï¼šã€Œæˆ‘è¦ºå¾—â€¦â€¦æˆ‘é€™è¼©å­å°±æ˜¯å€‹å¤±æ•—å“ï¼Œä¸ç®¡æ€éº¼åŠªåŠ›æœ€å¾Œéƒ½æœƒæç ¸â€¦â€¦ã€</div>', unsafe_allow_html=True)
    q1 = st.radio("ä»‹å…¥ç„¦é»ï¼š", ["1. æª¢è¦–è­‰æ“šï¼šã€Œä½ æ˜¯ä¾æ“šä»€éº¼å…·é«”äº‹ä»¶æˆ–è­‰æ“šï¼Œä¾†å®šç¾©è‡ªå·±æ˜¯ã€å¤±æ•—å“ã€çš„ï¼Ÿã€", "2. æƒ…æ„Ÿåæ˜ ï¼šã€Œè½èµ·ä¾†ä½ ç¾åœ¨çœŸçš„æ„Ÿåˆ°å¾ˆæŒ«æŠ˜ï¼Œé‚£ç¨®æ„Ÿè¦ºåƒæ˜¯è¢«å¾¹åº•æ‰“æ•—äº†â€¦â€¦ã€", "3. é€£çµéå»ï¼šã€Œé€™å¥è©±è®“ä½ è¯æƒ³åˆ°éå»èª°å°ä½ çš„è©•åƒ¹å—ï¼Ÿæˆ–æ˜¯èª°æ›¾ç¶“é€™æ¨£å°ä½ èªªï¼Ÿã€", "4. å°‹æ‰¾ä¾‹å¤–ï¼šã€Œåœ¨éå»é€™æ®µæ™‚é–“è£¡ï¼Œæœ‰æ²’æœ‰å“ªå€‹æ™‚åˆ»ï¼Œäº‹æƒ…å…¶å¯¦æ²’æœ‰æç ¸å¾—é‚£éº¼åš´é‡ï¼Ÿã€"], key="s2_q1")
    
    # --- æƒ…å¢ƒ 2 ---
    st.markdown('<div class="scenario-box"><b>æƒ…å¢ƒ 2ï¼šæ²ˆé»˜åƒµå±€</b><br>å€‹æ¡ˆå·²ç¶“æ²ˆé»˜äº†å°‡è¿‘ååˆ†é˜ã€‚ä»–çœ‹è‘—çª—å¤–ï¼Œä¼¼ä¹æ²’æœ‰è¦é–‹å£çš„æ„æ€ã€‚æ²»ç™‚å®¤çš„ç©ºæ°£è®Šå¾—æœ‰äº›å‡é‡ã€‚</div>', unsafe_allow_html=True)
    q2 = st.radio("è™•ç½®æ–¹å‘ï¼š", ["1. æŠ—æ‹’åˆ†æï¼šä»–å¯èƒ½åœ¨æŠ—æ‹’æŸäº›ç—›è‹¦çš„ç´ æï¼Œæˆ‘æ‡‰æ€è€ƒé€™ä»½æ²ˆé»˜èƒŒå¾Œçš„æ½›æ„è­˜æ„ç¾©ã€‚", "2. çµæ§‹å¼•å°ï¼šæˆ‘éœ€è¦åšé»ä»€éº¼ä¾†æ‰“ç ´åƒµå±€ï¼Œä¾‹å¦‚å›é¡§ä¸€ä¸‹ä¸Šæ¬¡çš„ä½œæ¥­æˆ–è¨­å®šä»Šå¤©è­°ç¨‹ã€‚", "3. è‡¨åœ¨é™ªä¼´ï¼šé€™ä»½æ²ˆé»˜æ˜¯çè²´çš„ï¼Œä»–æ­£åœ¨æ•´ç†è‡ªå·±ï¼Œæˆ‘åªéœ€å®‰éœé™ªä¼´ï¼Œæä¾›å®‰å…¨çš„ç©ºé–“ã€‚", "4. éç¨‹æºé€šï¼šæ²ˆé»˜æœ¬èº«å°±æ˜¯ä¸€ç¨®æºé€šï¼Œæˆ‘æ‡‰è©²è©¢å•ï¼šã€Œé€éæ²ˆé»˜ï¼Œä½ ä¼¼ä¹æƒ³å‘Šè¨´æˆ‘äº›ä»€éº¼ï¼Ÿã€"], key="s2_q2")

    # --- æƒ…å¢ƒ 3 ---
    st.markdown('<div class="scenario-box"><b>æƒ…å¢ƒ 3ï¼šæ²»ç™‚é—œä¿‚ç ´è£‚</b><br>å€‹æ¡ˆçªç„¶å°ä½ ç”Ÿæ°£ï¼šã€Œä½ ä¸€ç›´å•æˆ‘æ„Ÿå—æœ‰ä»€éº¼ç”¨ï¼Ÿé€™å°è§£æ±ºæˆ‘çš„ç¾å¯¦å•é¡Œä¸€é»å¹«åŠ©éƒ½æ²’æœ‰ï¼ã€</div>', unsafe_allow_html=True)
    q3 = st.radio("é¦–è¦å›æ‡‰ï¼š", ["1. åˆä½œå°è©±ï¼šã€Œè¬è¬ä½ å‘Šè¨´æˆ‘ï¼Œçœ‹ä¾†æˆ‘å€‘å°æ–¼ã€ä»€éº¼æœ‰å¹«åŠ©ã€çš„æƒ³æ³•ä¸å¤ªä¸€æ¨£ï¼Œæˆ‘å€‘è¦ä¸è¦ä¾†è¨è«–ä¸€ä¸‹ï¼Ÿã€", "2. åŒç†æ¥ç´ï¼šã€Œæˆ‘çœ‹è¦‹ä½ çœŸçš„å¾ˆè‘—æ€¥ï¼Œä½ å¾ˆå¸Œæœ›èƒ½å¿«é»å¥½èµ·ä¾†ï¼Œè€Œæˆ‘çš„æå•è®“ä½ æ„Ÿåˆ°æŒ«æŠ˜ï¼Œæ˜¯å—ï¼Ÿã€", "3. ç§»æƒ…æ¢ç´¢ï¼šã€Œä½ ç¾åœ¨å°æˆ‘çš„ç”Ÿæ°£ï¼Œæ˜¯ä¸æ˜¯å¾ˆåƒä½ å¹³å¸¸å°çˆ¶è¦ªæ„Ÿè¦ºåˆ°çš„é‚£ç¨®ç„¡åŠ›æ„Ÿï¼Ÿã€", "4. è¡Œå‹•ä¿®æ­£ï¼šã€Œå¥½ï¼Œé‚£æˆ‘å€‘ç¾åœ¨ä¾†èª¿æ•´æ–¹å‘ï¼Œçœ‹çœ‹å…·é«”ä¾†èªªæˆ‘å€‘å¯ä»¥åšå“ªäº›è¡Œç‚ºæ”¹è®Šã€‚ã€"], key="s2_q3")
    
    if st.button("ç¢ºèª Phase 2 æ‰€æœ‰å›ç­”"):
        if "1." in q1: update_axes(1.5, 1.5, "P2-Q1", "æª¢è¦–è­‰æ“š", "ç†æ€§è­‰æ“š")
        if "2." in q1: update_axes(-1.5, -1.5, "P2-Q1", "æƒ…æ„Ÿåæ˜ ", "æƒ…æ„Ÿé«”é©—")
        if "3." in q1: update_axes(-1.0, 2.0, "P2-Q1", "é€£çµéå»", "å‹•åŠ›åˆ†æ")
        if "4." in q1: update_axes(1.0, 1.0, "P2-Q1", "å°‹æ‰¾ä¾‹å¤–", "è¡Œå‹•å»ºæ§‹")
        
        if "1." in q2: update_axes(-1.0, 2.0, "P2-Q2", "æŠ—æ‹’åˆ†æ", "åˆ†æè¦–è§’")
        if "2." in q2: update_axes(2.0, 1.0, "P2-Q2", "çµæ§‹å¼•å°", "çµæ§‹ä»‹å…¥")
        if "3." in q2: update_axes(-2.0, -2.0, "P2-Q2", "è‡¨åœ¨é™ªä¼´", "äººæœ¬è¦–è§’")
        if "4." in q2: update_axes(-1.0, 1.0, "P2-Q2", "éç¨‹æºé€š", "ç³»çµ±è¦–è§’")

        if "1." in q3: update_axes(-1.0, 1.0, "P2-Q3", "åˆä½œå°è©±", "å¾Œç¾ä»£åˆä½œ")
        if "2." in q3: update_axes(-2.0, -1.0, "P2-Q3", "åŒç†æ¥ç´", "äººæœ¬åŒç†")
        if "3." in q3: update_axes(-1.0, 3.0, "P2-Q3", "ç§»æƒ…æ¢ç´¢", "å‹•åŠ›è©®é‡‹")
        if "4." in q3: update_axes(2.0, 2.0, "P2-Q3", "è¡Œå‹•ä¿®æ­£", "è¡Œç‚ºèª¿æ•´")
        st.success("æ•¸æ“šå·²è¨˜éŒ„ã€‚")

# ==========================================
# Phase 3: é™°å½±æ¢ç´¢ (å¢åŠ é¡Œç›®)
# ==========================================
elif step == "Phase 3. é™°å½±æ¢ç´¢ (åƒ¹å€¼è§€)":
    st.header("Phase 3: é™°å½±èˆ‡åç§»æƒ…")
    st.markdown("æœ¬éšæ®µé€éã€Œåå‘æŒ‡æ¨™ã€ï¼Œæ¸¬é‡æ‚¨å°æ–¼ç‰¹å®šæ²»ç™‚æƒ…å¢ƒçš„æ½›åœ¨ç„¦æ…®ã€‚")
    
    # --- Q1 ---
    st.subheader("Q1. æ²»ç™‚å¸«ç‰¹è³ªçš„é™°å½±")
    st.write("è«‹é¸å‡ºæ‚¨èªç‚º**æœ€ä¸å¯æ¥å—**ï¼ˆæœ€åƒå™©å¤¢ï¼‰çš„æ²»ç™‚å¸«å½¢è±¡ï¼š")
    
    shadow_options = {
        "A": "å¤±æ§çš„æ²»ç™‚å¸«ï¼šç•Œç·šæ¨¡ç³Šï¼Œè¢«å€‹æ¡ˆæƒ…ç·’æ·¹æ²’ï¼Œç”šè‡³è·Ÿè‘—å€‹æ¡ˆä¸€èµ·å“­æ³£ï¼Œå¤±å»å°ˆæ¥­ä½ç½®ã€‚",
        "B": "å†·è¡€çš„æ²»ç™‚å¸«ï¼šåƒå€‹å†°å†·çš„åˆ†æå„€å™¨ï¼Œåªæœ‰ç†è«–æ²’æœ‰æº«åº¦ï¼Œè®“å€‹æ¡ˆæ„Ÿè¦ºä¸åˆ°äººæ€§ã€‚",
        "C": "é¬¼æ‰“ç‰†çš„æ²»ç™‚å¸«ï¼šè«‡äº†å¾ˆä¹…å»æ¯«ç„¡é€²å±•ï¼Œæ²’æœ‰ç›®æ¨™ï¼Œæ¯é€±åªæ˜¯æ¼«ç„¡ç›®çš„åœ°èŠå¤©ã€‚",
        "D": "éœ¸é“çš„æ²»ç™‚å¸«ï¼šè‡ªä»¥ç‚ºæ˜¯å°ˆå®¶ï¼Œå°‡è‡ªå·±çš„åƒ¹å€¼è§€å¼·åŠ åœ¨å€‹æ¡ˆèº«ä¸Šï¼Œä¸å®¹è¨±åé§ã€‚"
    }
    shadow_1 = st.selectbox("ğŸ’€ ç¬¬ä¸€åæœ€ç„¡æ³•å¿å—çš„æ˜¯ï¼š", ["è«‹é¸æ“‡..."] + list(shadow_options.values()))
    shadow_2 = st.selectbox("ğŸ’€ ç¬¬äºŒåç„¡æ³•å¿å—çš„æ˜¯ï¼š", ["è«‹é¸æ“‡..."] + list(shadow_options.values()))
    
    # --- Q2 ---
    st.subheader("Q2. æ²»ç™‚æ­·ç¨‹çš„åƒµå±€")
    process_fear = st.radio("åœ¨è«®å•†éç¨‹ä¸­ï¼Œå“ªä¸€ç¨®ã€Œç‹€æ…‹ã€æœ€è®“æ‚¨æ„Ÿåˆ°ç„¦æ…®æˆ–è‡ªæˆ‘æ‡·ç–‘ï¼Ÿ", [
        "1. æ··äº‚ç„¡åºï¼šå€‹æ¡ˆè©±é¡Œè·³èºï¼Œæƒ…ç·’å¼µåŠ›æ¥µå¤§ï¼Œæˆ‘å®Œå…¨æŠ“ä¸åˆ°é‡é»ï¼Œè¦ºå¾—å ´é¢å¿«è¦å¤±æ§ã€‚",
        "2. è¡¨å±¤ç–é›¢ï¼šå€‹æ¡ˆå¾ˆæœ‰ç¦®è²Œåœ°é…åˆï¼Œä½†æ„Ÿè¦ºæˆ‘å€‘ä¹‹é–“éš”è‘—ä¸€å±¤åšåšçš„ç‰†ï¼Œç„¡æ³•æ¥è§¸çœŸå¯¦æƒ…æ„Ÿã€‚",
        "3. ç†æ™ºåŒ–ï¼šå€‹æ¡ˆä¸æ–·åœ°åˆ†æè‡ªå·±ï¼Œèªªå¾—é ­é ­æ˜¯é“ï¼Œä½†å®Œå…¨æ²’æœ‰ä»»ä½•è¡Œç‚ºä¸Šçš„æ”¹è®Šã€‚",
        "4. ä¾è³´é€€åŒ–ï¼šå€‹æ¡ˆå®Œå…¨ä¾è³´æˆ‘çš„å»ºè­°ï¼Œåƒå€‹å­©å­ä¸€æ¨£ä¸é¡˜ç‚ºè‡ªå·±è² è²¬ï¼Œç­‰å¾…æˆ‘å»æ‹¯æ•‘ä»–ã€‚"
    ])

    if st.button("ç¢ºèª Phase 3 æ‰€æœ‰å›ç­”"):
        if shadow_1 != "è«‹é¸æ“‡..." and shadow_2 != "è«‹é¸æ“‡..." and shadow_1 != shadow_2:
             def analyze_shadow(text, weight):
                if "å¤±æ§" in text: update_axes(1.5 * weight, 0, "P3-Q1", "æ€•å¤±æ§", f"é™°å½±ï¼šéœ€æ±‚çµæ§‹ (w={weight})")
                if "å†·è¡€" in text: update_axes(-1.5 * weight, -1.0 * weight, "P3-Q1", "æ€•å†·è¡€", f"é™°å½±ï¼šéœ€æ±‚æƒ…æ„Ÿ (w={weight})")
                if "é¬¼æ‰“ç‰†" in text: update_axes(1.0 * weight, 1.5 * weight, "P3-Q1", "æ€•æ²’æ•ˆ", f"é™°å½±ï¼šéœ€æ±‚æ•ˆèƒ½ (w={weight})")
                if "éœ¸é“" in text: update_axes(-1.5 * weight, 0, "P3-Q1", "æ€•éœ¸é“", f"é™°å½±ï¼šéœ€æ±‚å°Šé‡ (w={weight})")
             analyze_shadow(shadow_1, 1.5)
             analyze_shadow(shadow_2, 1.0)
        
        if "1." in process_fear: update_axes(1.5, 0.5, "P3-Q2", "æ€•æ··äº‚", "ææ‡¼ï¼šæ¸´æœ›ç§©åº")
        if "2." in process_fear: update_axes(-1.5, -1.5, "P3-Q2", "æ€•ç–é›¢", "ææ‡¼ï¼šæ¸´æœ›æ¥è§¸")
        if "3." in process_fear: update_axes(0, -2.0, "P3-Q2", "æ€•ç†æ™ºåŒ–", "ææ‡¼ï¼šæ¸´æœ›é«”é©—")
        if "4." in process_fear: update_axes(-1.0, 1.0, "P3-Q2", "æ€•ä¾è³´", "ææ‡¼ï¼šæ¸´æœ›è³¦èƒ½")
        st.success("æ•¸æ“šå·²è¨˜éŒ„ã€‚")

# ==========================================
# Phase 4: ç©ºé–“é…ç½® (æ›´ç”Ÿæ´»åŒ–çš„æƒ…å¢ƒ)
# ==========================================
elif step == "Phase 4. ç©ºé–“é…ç½® (æ¡†æ¶è§€)":
    st.header("Phase 4: ç©ºé–“å¿ƒç†èˆ‡äººéš›ç•Œç·š")
    st.markdown("""
    <div class="warning-box">
    <b>ğŸ”¥ æƒ…å¢ƒè½‰æ›ï¼šç§äººé ˜åŸŸçš„æ·±åº¦å°è©±</b><br>
    è«‹æš«æ™‚æ”¾ä¸‹ã€Œè«®å•†å®¤æ¨™æº–é…ç½®ã€çš„è€ƒé‡ã€‚æƒ³åƒæ‚¨é‚€è«‹ä¸€ä½éå¸¸ä¿¡ä»»çš„æ‘¯å‹åˆ°å®¶ä¸­ï¼Œæº–å‚™é€²è¡Œä¸€å ´æ·±å…¥éˆé­‚çš„å¾¹å¤œé•·è«‡ã€‚<br>
    ç‚ºäº†è®“<b>ã€Œæ‚¨è‡ªå·±ã€</b>æ„Ÿåˆ°æœ€è‡ªåœ¨ã€æœ€èƒ½çœŸèª äº¤æµï¼Œæ‚¨èº«é«”ç›´è¦ºæœƒé¸æ“‡å“ªä¸€ç¨®åæ³•ï¼Ÿ
    </div>
    """, unsafe_allow_html=True)

    def get_layout_svg(layout_type):
        base_svg = '<svg width="250" height="180" xmlns="http://www.w3.org/2000/svg" style="background-color:#ffffff; border:1px solid #eee;">'
        if layout_type == "SideBySide":
            content = """<rect x="50" y="80" width="150" height="50" rx="10" fill="#f1c40f" opacity="0.3"/><circle cx="100" cy="105" r="20" fill="#3498db" /> <text x="90" y="110" fill="white" font-size="10">You</text><circle cx="150" cy="105" r="20" fill="#e74c3c" /> <text x="140" y="110" fill="white" font-size="10">Friend</text><text x="75" y="160" fill="#666" font-size="12">ä¸¦è‚©è€Œå (æ²™ç™¼)</text>"""
        elif layout_type == "L_Shape":
            content = """<rect x="120" y="90" width="40" height="40" fill="#ecf0f1" stroke="#bdc3c7"/><circle cx="90" cy="70" r="20" fill="#3498db" /> <text x="80" y="75" fill="white" font-size="10">You</text><circle cx="160" cy="140" r="20" fill="#e74c3c" /> <text x="150" y="145" fill="white" font-size="10">Friend</text><text x="150" y="40" fill="#666" font-size="12">èˆ’é©æ–œè§’ (Lå‹)</text>"""
        elif layout_type == "Formal":
            content = """<rect x="105" y="40" width="40" height="100" fill="#ecf0f1" stroke="#bdc3c7"/><circle cx="60" cy="90" r="20" fill="#3498db" /> <text x="50" y="95" fill="white" font-size="10">You</text><circle cx="190" cy="90" r="20" fill="#e74c3c" /> <text x="180" y="95" fill="white" font-size="10">Friend</text><text x="90" y="25" fill="#666" font-size="12">é¢å°é¢ (éš”è‘—æ¡Œå­)</text>"""
        elif layout_type == "Separate":
            content = """<circle cx="50" cy="90" r="20" fill="#3498db" /> <text x="40" y="95" fill="white" font-size="10">You</text><circle cx="200" cy="90" r="20" fill="#e74c3c" /> <text x="190" y="95" fill="white" font-size="10">Friend</text><path d="M 80 90 L 170 90" stroke="#999" stroke-width="1" stroke-dasharray="4"/><text x="85" y="150" fill="#666" font-size="12">ç¨ç«‹åº§æ¤… (ä¿æŒè·é›¢)</text>"""
        return base_svg + content + '</svg>'

    c1, c2 = st.columns(2)
    with c1:
        st.markdown(get_layout_svg("SideBySide"), unsafe_allow_html=True)
        if st.button("1. ä¸¦è‚©è€Œå (æ²™ç™¼)"):
            update_axes(-2.0, -1.5, "P4-Q1", "ä¸¦è‚©", "ç©ºé–“ï¼šé«˜è¦ªå¯†é«”é©—")
            st.success("å·²é¸æ“‡")
        st.markdown(get_layout_svg("L_Shape"), unsafe_allow_html=True)
        if st.button("2. èˆ’é©æ–œè§’ (Lå‹)"):
            update_axes(-0.5, 0, "P4-Q1", "Lå‹", "ç©ºé–“ï¼šäººæœ¬æŠ˜è¡·")
            st.success("å·²é¸æ“‡")
    with c2:
        st.markdown(get_layout_svg("Formal"), unsafe_allow_html=True)
        if st.button("3. é¢å°é¢ (éš”æ¡Œ)"):
            update_axes(1.5, 1.0, "P4-Q1", "å°å", "ç©ºé–“ï¼šçµæ§‹èªçŸ¥")
            st.success("å·²é¸æ“‡")
        st.markdown(get_layout_svg("Separate"), unsafe_allow_html=True)
        if st.button("4. ç¨ç«‹åº§æ¤… (è·é›¢)"):
            update_axes(1.0, 2.0, "P4-Q1", "ç¨ç«‹æ¤…", "ç©ºé–“ï¼šç•Œç·šè§€å¯Ÿ")
            st.success("å·²é¸æ“‡")

    st.markdown("---")
    st.subheader("Q2. è¼”åŠ©æºé€šåå¥½")
    st.write("åœ¨å°è©±éç¨‹ä¸­ï¼Œç‚ºäº†è®“å°æ–¹æ›´æ¸…æ¥šæ‚¨çš„æƒ³æ³•ï¼Œæ‚¨æ˜¯å¦å‚¾å‘**æ‹¿å‡ºä¸€å¼µç´™æˆ–ç™½æ¿ï¼Œç•«åœ–/å¯«å­—/åˆ—é»**ä¾†è§£é‡‹ï¼Ÿ")
    
    use_visual = st.radio("ç›´è¦ºç¿’æ…£ï¼š", ["æ˜¯ï¼Œæˆ‘å–œæ­¡è¦–è¦ºåŒ–ã€ç•«åœ–æˆ–åˆ—é»ï¼Œé€™æ¨£æ¯”è¼ƒæ¸…æ¥šã€‚", "å¦ï¼Œæˆ‘å‚¾å‘ç´”å£èªæè¿°ï¼Œçœ¼ç¥èˆ‡æƒ…æ„Ÿäº¤æµæ›´é‡è¦ã€‚"])
    if st.button("ç¢ºèª Q2"):
        if "æ˜¯" in use_visual: update_axes(1.5, 1.5, "P4-Q2", "ä½¿ç”¨è¦–è¦º", "æºé€šï¼šçµæ§‹è¦–è¦ºåŒ–")
        else: update_axes(-0.5, -0.5, "P4-Q2", "ä¸ä½¿ç”¨", "æºé€šï¼šå£èªæµå‹•")
        st.success("æ•¸æ“šå·²è¨˜éŒ„ã€‚")

# ==========================================
# Phase 5: ç¶œåˆåˆ†æå ±å‘Š (æ–°å¢çŸ›ç›¾æª¢æ¸¬)
# ==========================================
elif step == "Phase 5. ç¶œåˆåˆ†æå ±å‘Š":
    st.title("ğŸ“Š è«®å•†å°ˆæ¥­å–å‘åˆ†æå ±å‘Š")
    
    # æª¢æŸ¥æ˜¯å¦æœ‰æ•¸æ“š
    if len(st.session_state.raw_scores_x) == 0:
        st.error("âš ï¸ å°šæœªåµæ¸¬åˆ°ä½œç­”æ•¸æ“šã€‚è«‹å›åˆ°å„éšæ®µå®Œæˆé¡Œç›®ä¸¦é»æ“Šã€Œç¢ºèªæŒ‰éˆ•ã€ã€‚")
        st.stop()

    x = st.session_state.axis_obj_sub

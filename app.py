import streamlit as st
import pandas as pd
import altair as alt

# --- ç³»çµ±è¨­å®š ---
st.set_page_config(page_title="è«®å•†å°ˆæ¥­å–å‘æ·±åº¦æ¢ç´¢ç³»çµ± (CTPS-Based)", page_icon="ğŸ§­", layout="wide")

# --- Session State åˆå§‹åŒ– (åŸºæ–¼æ–‡ç»çš„é›™è»¸å‘) ---
if 'axis_obj_sub' not in st.session_state:
    # Xè»¸: æ­£å€¼=å®¢è§€/å¯¦è­‰/çµæ§‹, è² å€¼=ä¸»è§€/å»ºæ§‹/æµå‹•
    st.session_state.axis_obj_sub = 0.0 
if 'axis_ana_exp' not in st.session_state:
    # Yè»¸: æ­£å€¼=ç†æ€§/åˆ†æ/æ€è€ƒ, è² å€¼=é«”é©—/æƒ…æ„Ÿ/è¦ºå¯Ÿ
    st.session_state.axis_ana_exp = 0.0
if 'history' not in st.session_state:
    st.session_state.history = []

# --- è¼”åŠ©å‡½æ•¸ï¼šæ›´æ–°é›™è»¸åˆ†æ•¸ ---
def update_axes(x_delta, y_delta, reasoning):
    st.session_state.axis_obj_sub += x_delta
    st.session_state.axis_ana_exp += y_delta
    st.session_state.history.append(reasoning)

# --- å´é‚Šæ¬„ ---
st.sidebar.title("ğŸ§­ å°ˆæ¥­å°èˆª")
st.sidebar.info("æœ¬ç³»çµ±è¨ˆåˆ†é‚è¼¯ä¾æ“š CTPS èˆ‡ TOPS-R é‡è¡¨ä¹‹æ ¸å¿ƒç¶­åº¦è¨­è¨ˆã€‚")
step = st.sidebar.radio(
    "éšæ®µé¸æ“‡ï¼š",
    ["å‰è¨€ï¼šç†è«–æ¶æ§‹", "1. éš±å–»æŠ•å°„ (è§’è‰²è§€)", "2. è‡¨åºŠæ±ºç­– (æ”¹è®Šè§€)", "3. é™°å½±æ¢ç´¢ (åƒ¹å€¼è§€)", "4. ç©ºé–“é…ç½® (æ¡†æ¶è§€)", "5. ç¶œåˆåˆ†æå ±å‘Š"]
)

# ==========================================
# å‰è¨€
# ==========================================
if step == "å‰è¨€ï¼šç†è«–æ¶æ§‹":
    st.title("è«®å•†å°ˆæ¥­å–å‘æ·±åº¦æ¢ç´¢ç³»çµ±")
    st.markdown("""
    ### åš´è¬¹èˆ‡å‰µæ„çš„çµåˆ
    æœ¬ç³»çµ±æ—¨åœ¨å”åŠ©è«®å•†å¸«æ¢ç´¢å…¶æ½›åœ¨çš„**ç†è«–å–å‘ (Theoretical Orientation)**ã€‚
    æ‰€æœ‰çš„æ¸¬é©—ç’°ç¯€çš†å°æ‡‰è‡³ä»¥ä¸‹å…©å€‹å­¸è¡“æ ¸å¿ƒç¶­åº¦ (Based on Poznanski & McLennan, 1995)ï¼š
    
    1.  **çŸ¥è­˜è«–ç«‹å ´ (Epistemology)**ï¼šæ‚¨ç›¸ä¿¡çœŸç†æ˜¯å®¢è§€å­˜åœ¨çš„(Objective)ï¼Œé‚„æ˜¯å€‹äººä¸»è§€å»ºæ§‹çš„(Subjective)ï¼Ÿ
    2.  **ä»‹å…¥ç„¦é» (Focus)**ï¼šæ‚¨å‚¾å‘è™•ç†ç†æ€§çš„èªçŸ¥çµæ§‹(Analytical)ï¼Œé‚„æ˜¯ç•¶ä¸‹çš„æƒ…æ„Ÿé«”é©—(Experiential)ï¼Ÿ
    """)
    st.warning("âš ï¸ è«‹æ†‘ç›´è¦ºä½œç­”ï¼Œé€™ä¸æ˜¯è€ƒè©¦ï¼Œæ²’æœ‰æ¨™æº–ç­”æ¡ˆã€‚")

# ==========================================
# éšæ®µ 1: éš±å–»æŠ•å°„ (å°æ‡‰ï¼šæ²»ç™‚å¸«è§’è‰²èˆ‡æ¬ŠåŠ›)
# ==========================================
elif step == "1. éš±å–»æŠ•å°„ (è§’è‰²è§€)":
    st.header("Phase 1: æ²»ç™‚é—œä¿‚ä¸­çš„è§’è‰²")
    st.markdown("**ç†è«–ä¾æ“š**ï¼šæ­¤éšæ®µæ¸¬é‡æ‚¨åœ¨ *Directiveness (æŒ‡å°æ€§)* èˆ‡ *Interpersonal Stance (äººéš›ç«‹å ´)* ä¸Šçš„å‚¾å‘ã€‚")
    
    st.subheader("Q1. ç™»å±±éš±å–»")
    st.write("å¦‚æœè«®å•†æ˜¯ä¸€æ¬¡ç™»å±±ï¼Œæ‚¨è¦ºå¾—æœ€è‡ªåœ¨çš„ä½ç½®æ˜¯ï¼Ÿ")
    
    choice1 = st.radio("è«‹é¸æ“‡ï¼š", [
        "A. åš®å°ï¼šèµ°åœ¨å‰é¢ï¼Œæ‰‹æŒåœ°åœ–ï¼Œé å‘Šè·¯æ³ (é«˜æŒ‡å°/å®¢è§€)",
        "B. ä¼´ä¾¶ï¼šä¸¦è‚©è€Œè¡Œï¼Œé€Ÿåº¦ä¸€è‡´ï¼Œç›¸äº’æ‰¶æŒ (ä½æŒ‡å°/é«”é©—)",
        "C. è§€å¯Ÿè€…ï¼šèµ°åœ¨å¾Œæ–¹ï¼Œåˆ†ææ­¥ä¼ï¼Œä¿æŒè·é›¢ (ä½æŒ‡å°/åˆ†æ)",
        "D. æ•™ç·´ï¼šè¨­å®šç›®æ¨™ï¼Œåœ¨æ—å¶å–Šï¼Œä¿®æ­£å§¿å‹¢ (é«˜æŒ‡å°/ç†æ€§)"
    ])
    
    if st.button("ç¢ºèª Q1"):
        if "A" in choice1: update_axes(2.0, 1.0, "ç™»å±±-åš®å°: å‚¾å‘å®¢è§€æŒ‡å°èˆ‡çµæ§‹")
        if "B" in choice1: update_axes(-2.0, -2.0, "ç™»å±±-ä¼´ä¾¶: å‚¾å‘ä¸»è§€é«”é©—èˆ‡é€£çµ")
        if "C" in choice1: update_axes(-1.0, 3.0, "ç™»å±±-è§€å¯Ÿè€…: å‚¾å‘å…§åœ¨å‹•åŠ›åˆ†æ")
        if "D" in choice1: update_axes(2.0, 2.0, "ç™»å±±-æ•™ç·´: å‚¾å‘ç†æ€§è¡Œç‚ºä¿®æ­£")
        st.success("å·²è¨˜éŒ„æ‚¨çš„è§’è‰²å‚¾å‘ã€‚")

    st.markdown("---")
    st.subheader("Q2. é‡åŒ–æ ¡æº–é¡Œ (Likert Scale)")
    st.write("è«‹é‡å°ä»¥ä¸‹æè¿°è©•åˆ†ï¼Œä»¥æ ¡æº–æ‚¨çš„ç†è«–ä¿¡åº¦ï¼š")
    q2_score = st.slider("ã€Œæˆ‘èªç‚ºæ²»ç™‚å¸«ä¿æŒå®¢è§€ä¸­ç«‹çš„ã€æŠ€è¡“å°ˆå®¶ã€å½¢è±¡ï¼Œæ¯”å±•ç¾å€‹äººç‰¹è³ªæ›´é‡è¦ã€‚ã€", 1, 5, 3)
    
    if st.button("ç¢ºèª Q2"):
        # 1åˆ†=éå¸¸ä¸åŒæ„(ä¸»è§€), 5åˆ†=éå¸¸åŒæ„(å®¢è§€)
        # è½‰æ›ç‚º -2 åˆ° +2
        val = q2_score - 3
        update_axes(val * 1.5, 0, f"æ ¡æº–é¡Œ-å°ˆå®¶å½¢è±¡: åˆ†æ•¸{q2_score} (æ¬Šé‡1.5)")
        st.success("æ ¡æº–å®Œæˆã€‚")

# ==========================================
# éšæ®µ 2: è‡¨åºŠæ±ºç­– (å°æ‡‰ï¼šæ”¹è®Šæ©Ÿåˆ¶)
# ==========================================
elif step == "2. è‡¨åºŠæ±ºç­– (æ”¹è®Šè§€)":
    st.header("Phase 2: æ”¹è®Šæ˜¯å¦‚ä½•ç™¼ç”Ÿçš„ï¼Ÿ")
    st.markdown("**ç†è«–ä¾æ“š**ï¼šæ­¤éšæ®µæ¸¬é‡æ‚¨çš„ *Mechanism of Change (æ”¹è®Šæ©Ÿåˆ¶)* ä¿¡å¿µã€‚")
    
    st.info("æƒ…å¢ƒï¼šå€‹æ¡ˆå°æ˜é™·å…¥å¼·çƒˆçš„è‡ªæˆ‘æ‡·ç–‘ï¼Œåœ¨æœƒè«‡ä¸­ä¸æ–·é‡è¤‡ã€Œæˆ‘å°±æ˜¯å€‹å¤±æ•—è€…ã€ã€‚")
    
    choice_scene = st.selectbox("æ‚¨ç•¶ä¸‹æœ€æƒ³æ¡å–çš„ä»‹å…¥ç­–ç•¥æ˜¯ï¼Ÿ", [
        "è«‹é¸æ“‡...",
        "1. è˜‡æ ¼æ‹‰åº•å¼æå•ï¼šæª¢è¦–ã€Œå¤±æ•—è€…ã€é€™å€‹å®šç¾©çš„è­‰æ“šèˆ‡é‚è¼¯ (CBT)",
        "2. åŒç†åæ˜ ï¼šæ·±æ·±åœ°æ¥ç´ä»–æ­¤åˆ»çš„æŒ«æŠ˜æ„Ÿï¼Œè®“ä»–æ„Ÿåˆ°è¢«æ‡‚ (Humanistic)",
        "3. è©®é‡‹ï¼šé€£çµä»–ç«¥å¹´è¢«çˆ¶è¦ªæ‰¹è©•çš„ç¶“é©—ï¼ŒæŒ‡å‡ºé€™æ˜¯å…§å°„çš„è²éŸ³ (Psychodynamic)",
        "4. ä¾‹å¤–å•å¥ï¼šè©¢å•ä»–éå»æœ‰æ²’æœ‰å“ªä¸€æ¬¡è¦ºå¾—è‡ªå·±ã€Œç¨å¾®æˆåŠŸã€çš„æ™‚å€™ï¼Ÿ (SFBT)"
    ])
    
    if st.button("ç¢ºèªç­–ç•¥"):
        if "1" in choice_scene: update_axes(2.0, 2.0, "æƒ…å¢ƒ-æå•: èšç„¦ç†æ€§èªçŸ¥é‡æ§‹")
        if "2" in choice_scene: update_axes(-2.0, -2.0, "æƒ…å¢ƒ-åŒç†: èšç„¦ç•¶ä¸‹æƒ…æ„Ÿé«”é©—")
        if "3" in choice_scene: update_axes(-1.0, 3.0, "æƒ…å¢ƒ-è©®é‡‹: èšç„¦æ½›æ„è­˜æ´å¯Ÿ")
        if "4" in choice_scene: update_axes(1.0, 1.0, "æƒ…å¢ƒ-ä¾‹å¤–: èšç„¦å»ºæ§‹è§£æ±ºæ–¹æ¡ˆ") 
        # SFBT é›–æ˜¯å¾Œç¾ä»£(ä¸»è§€)ï¼Œä½†åœ¨æ“ä½œä¸Šåå‘èªçŸ¥èˆ‡è¡Œå‹•(Obj/Ana)ï¼Œæ•…çµ¦äºˆä¸­é–“åæ­£å€¼
        st.success("ä»‹å…¥ç­–ç•¥å·²åˆ†æã€‚")

# ==========================================
# éšæ®µ 3: é™°å½±æ¢ç´¢ (å°æ‡‰ï¼šåƒ¹å€¼èˆ‡åç§»æƒ…)
# ==========================================
elif step == "3. é™°å½±æ¢ç´¢ (åƒ¹å€¼è§€)":
    st.header("Phase 3: ææ‡¼èˆ‡é¿å…")
    st.markdown("**ç†è«–ä¾æ“š**ï¼šä¾æ“š *Coan (1979)*ï¼Œè«®å•†å¸«çš„å–å‘åæ˜ äº†å…¶äººæ ¼ç‰¹è³ªèˆ‡å°ç‰¹å®šç‹€æ…‹çš„ç„¦æ…®ç®¡ç†ã€‚")
    
    st.write("æ‚¨æœ€**ç„¡æ³•å¿å—**è‡ªå·±æˆç‚ºå“ªä¸€ç¨®æ²»ç™‚å¸«ï¼Ÿ")
    shadow = st.multiselect("å¯è¤‡é¸ (é€™åæ˜ äº†æ‚¨çš„é€†å‘éœ€æ±‚)ï¼š", [
        "A. å¤±æ§çš„ï¼šç•Œç·šæ¨¡ç³Šï¼Œè¢«å€‹æ¡ˆçš„æƒ…ç·’æ·¹æ²’ï¼Œä¸çŸ¥æ‰€æªã€‚",
        "B. å†·è¡€çš„ï¼šåƒå€‹æ©Ÿå™¨äººï¼Œé›–æœ‰æŠ€è¡“ä½†æ²’æœ‰äººå‘³ã€‚",
        "C. æ²’æ•ˆç‡çš„ï¼šè«‡äº†å¾ˆä¹…å»åŸåœ°æ‰“è½‰ï¼Œæ²’æœ‰å…·é«”é€²å±•ã€‚",
        "D. æ­¦æ–·çš„ï¼šæŠŠè‡ªå·±çš„åƒ¹å€¼è§€å¼·åŠ åœ¨å€‹æ¡ˆèº«ä¸Šã€‚"
    ])
    
    if st.button("åˆ†æé™°å½±"):
        # æ€•å¤±æ§ -> è¿½æ±‚çµæ§‹ (Objective)
        if "A" in shadow: update_axes(1.5, 0, "é™°å½±-æ€•å¤±æ§: æ½›åœ¨éœ€æ±‚ç‚ºçµæ§‹èˆ‡ç•Œç·š")
        # æ€•å†·è¡€ -> è¿½æ±‚é—œä¿‚ (Subjective/Experiential)
        if "B" in shadow: update_axes(-1.5, -1.0, "é™°å½±-æ€•å†·è¡€: æ½›åœ¨éœ€æ±‚ç‚ºæƒ…æ„Ÿé€£çµ")
        # æ€•æ²’æ•ˆ -> è¿½æ±‚ç›®æ¨™ (Objective/Analytical)
        if "C" in shadow: update_axes(1.0, 1.5, "é™°å½±-æ€•æ²’æ•ˆ: æ½›åœ¨éœ€æ±‚ç‚ºå…·é«”æ”¹è®Š")
        # æ€•æ­¦æ–· -> è¿½æ±‚å°Šé‡ (Subjective)
        if "D" in shadow: update_axes(-1.5, 0, "é™°å½±-æ€•æ­¦æ–·: æ½›åœ¨éœ€æ±‚ç‚ºå€‹æ¡ˆä¸»é«”æ€§")
        st.success("é™°å½±åˆ†æå®Œæˆã€‚")

# ==========================================
# éšæ®µ 4: ç©ºé–“é…ç½® (å°æ‡‰ï¼šæ²»ç™‚æ¡†æ¶)
# ==========================================
elif step == "4. ç©ºé–“é…ç½® (æ¡†æ¶è§€)":
    st.header("Phase 4: ç‰©ç†ç’°å¢ƒèˆ‡æ²»ç™‚æ¡†æ¶")
    st.markdown("**ç†è«–ä¾æ“š**ï¼šç’°å¢ƒå¿ƒç†å­¸é¡¯ç¤ºï¼Œç©ºé–“é…ç½®åæ˜ äº†æ²»ç™‚å¸«å° *Neutrality (ä¸­ç«‹æ€§)* èˆ‡ *Transparency (é€æ˜åº¦)* çš„çœ‹æ³•ã€‚")
    
    dist = st.slider("Q1. ç†æƒ³çš„åº§ä½è·é›¢ (0=æ¥µè¿‘/è†è“‹ç¢°è†è“‹, 10=æ¥µé /ç”šè‡³èƒŒå°)", 0, 10, 5)
    struct = st.checkbox("Q2. è«®å•†å®¤å…§å¿…é ˆè¦æœ‰ç™½æ¿æˆ–æ›åœ– (è¦–è¦ºåŒ–å·¥å…·)")
    
    if st.button("ç¢ºèªé…ç½®"):
        # è·é›¢ï¼šè¿‘=é«”é©—/ä¸»è§€, é =åˆ†æ/å®¢è§€
        # 5æ˜¯ä¸­é»ï¼Œ<5 å¾€é«”é©—æ‰£åˆ†ï¼Œ>5 å¾€åˆ†æåŠ åˆ†
        dist_score = (dist - 5) * 0.5
        update_axes(0, dist_score, f"ç©ºé–“-è·é›¢: {dist}")
        
        if struct:
            update_axes(1.5, 1.0, "ç©ºé–“-ç™½æ¿: é‡è¦–çµæ§‹åŒ–æ•™å­¸")
        else:
            update_axes(-0.5, -0.5, "ç©ºé–“-ç„¡ç™½æ¿: é‡è¦–è‡ªç„¶æµå‹•")
            
        st.success("ç©ºé–“å¿ƒç†åˆ†æå®Œæˆã€‚")

# ==========================================
# éšæ®µ 5: ç¶œåˆåˆ†æå ±å‘Š
# ==========================================
elif step == "5. ç¶œåˆåˆ†æå ±å‘Š":
    st.title("ğŸ“Š è«®å•†å°ˆæ¥­å–å‘åˆ†æå ±å‘Š")
    
    x = st.session_state.axis_obj_sub
    y = st.session_state.axis_ana_exp
    
    # 1. åº§æ¨™è¦–è¦ºåŒ– (Scatter Plot)
    st.subheader("1. ç†è«–åœ°åœ–å®šä½ (Theoretical Mapping)")
    st.markdown(f"æ‚¨çš„è½é»åº§æ¨™ï¼šX (å®¢è§€æ€§) = **{x:.2f}**, Y (ç†æ€§åˆ†æ) = **{y:.2f}**")
    
    # å»ºç«‹æ•¸æ“šæ¡†ä»¥ç¹ªåœ–
    source = pd.DataFrame({
        'X': [x], 'Y': [y], 'Label': ['æ‚¨çš„ä½ç½®']
    })
    
    # èƒŒæ™¯è±¡é™å®šç¾©
    quadrants = pd.DataFrame({
        'x': [-4, 4, -4, 4],
        'y': [4, 4, -4, -4],
        'text': ['ç²¾ç¥åˆ†æ/å‹•åŠ›\n(Insight)', 'CBT/ç†æƒ…/ç‰¹è³ªå› ç´ \n(Rational)', 'äººæœ¬/å­˜åœ¨/å®Œå½¢\n(Affective)', 'è¡Œç‚º/ç¾å¯¦/ç­–ç•¥\n(Action)']
    })
    
    chart = alt.Chart(source).mark_circle(size=200, color='red').encode(
        x=alt.X('X', scale=alt.Scale(domain=[-10, 10]), title='ä¸»è§€/å»ºæ§‹ <-----> å®¢è§€/å¯¦è­‰'),
        y=alt.Y('Y', scale=alt.Scale(domain=[-10, 10]), title='é«”é©—/æƒ…æ„Ÿ <-----> ç†æ€§/æ€è€ƒ'),
        tooltip=['Label', 'X', 'Y']
    ).interactive()
    
    # åŠ ä¸Šæ–‡å­—æ¨™ç±¤ (ç°¡åŒ–ç‰ˆï¼ŒStreamlit ç¹ªåœ–é™åˆ¶)
    st.altair_chart(chart, use_container_width=True)
    st.caption("ä¸Šåœ–ç´…é»ç‚ºæ‚¨çš„è½é»ã€‚å››å€‹è§’è½ä»£è¡¨ä¸åŒå­¸æ´¾çš„æ¥µç«¯å€¼ã€‚")

    # 2. çµæœè§£é‡‹
    st.subheader("2. é©é…æ€§è§£æ")
    
    if x >= 0 and y >= 0:
        st.success("ã€ç¬¬ä¸€è±¡é™ï¼šèªçŸ¥èˆ‡è¡Œç‚ºå–å‘ã€‘\næ‚¨å‚¾å‘ç›¸ä¿¡å•é¡Œæœ‰å…¶å®¢è§€æˆå› ï¼Œä¸”èƒ½é€éå­¸ç¿’ã€æ€è€ƒèˆ‡ç·´ç¿’ä¾†ä¿®æ­£ã€‚æ‚¨é©åˆçµæ§‹åŒ–ã€ç›®æ¨™å°å‘çš„å­¸æ´¾ (CBT, REBT, SFBT)ã€‚")
    elif x < 0 and y >= 0:
        st.info("ã€ç¬¬äºŒè±¡é™ï¼šå¿ƒç†å‹•åŠ›å–å‘ã€‘\næ‚¨å‚¾å‘æ¢ç´¢å€‹æ¡ˆçš„å…§åœ¨ä¸–ç•Œèˆ‡æ½›æ„è­˜çµæ§‹ã€‚æ‚¨ç›¸ä¿¡é€éç†æ€§çš„æ´å¯Ÿ (Insight) èˆ‡è§£é‡‹ï¼Œèƒ½å¸¶ä¾†æ·±å±¤æ”¹è®Š (Psychoanalysis, Psychodynamic)ã€‚")
    elif x < 0 and y < 0:
        st.warning("ã€ç¬¬ä¸‰è±¡é™ï¼šäººæœ¬èˆ‡é«”é©—å–å‘ã€‘\næ‚¨ç›¸ä¿¡é—œä¿‚æœ¬èº«å°±æ˜¯æ²»ç™‚ã€‚æ‚¨é‡è¦–æ­¤æ™‚æ­¤åˆ»çš„çœŸèª æ¥è§¸èˆ‡æƒ…æ„Ÿæµå‹•ï¼Œç”šæ–¼æŠ€è¡“æ“ä½œ (Person-Centered, Gestalt, Existential)ã€‚")
    else:
        st.error("ã€ç¬¬å››è±¡é™ï¼šç­–ç•¥èˆ‡è¡Œå‹•å–å‘ã€‘\né€™æ˜¯ä¸€å€‹è¼ƒç¨ç‰¹çš„çµ„åˆï¼Œé‡è¦–å…·é«”çš„è¡Œå‹•æ”¹è®Šï¼Œä½†é—œæ³¨å€‹åˆ¥åŒ–çš„ä¸»è§€æ„ç¾©ã€‚å¯èƒ½å‚¾å‘æ–¼ç¾å¯¦æ²»ç™‚ (Reality Therapy) æˆ–ç‰¹å®šçš„è¡Œç‚ºè¨“ç·´ã€‚")

    # 3. æ­·ç¨‹æª¢è¦–
    with st.expander("æŸ¥çœ‹è©³ç´°åˆ¤æ–·ä¾æ“š (Trace Logic)"):
        for i, item in enumerate(st.session_state.history):
            st.write(f"{i+1}. {item}")

    st.markdown("---")
    st.caption("æœ¬å ±å‘Šåƒ…ä¾›å°ˆæ¥­æ¢ç´¢åƒè€ƒï¼Œä¾æ“š CTPS ç†è«–æ¶æ§‹ç”Ÿæˆã€‚")
